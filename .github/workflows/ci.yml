name: ğŸ§ª CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ” Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get dependencies
      run: flutter pub get

    - name: ğŸ”§ Verify Flutter installation
      run: flutter doctor -v

    - name: âš¡ Analyze code
      run: flutter analyze --fatal-infos

    - name: ğŸ§ª Run unit tests
      run: flutter test --coverage --reporter=expanded

    - name: ğŸ“Š Upload coverage to Codecov (optional)
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # Job separato per il build (opzionale ma utile)
  build:
    name: ğŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: test # Esegue solo se i test passano

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get dependencies
      run: flutter pub get

    - name: ğŸŒ Build web
      run: flutter build web --web-renderer canvaskit

    - name: ğŸ“± Build APK
      run: flutter build apk --debug

  # Protezione branch - questo step fallirÃ  se i test precedenti falliscono
  protection:
    name: ğŸ›¡ï¸ Branch Protection
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()

    steps:
    - name: âŒ Fail if tests failed
      if: needs.test.result != 'success'
      run: |
        echo "âŒ Tests failed! Cannot proceed with push/merge."
        echo "ğŸ”§ Fix the failing tests before pushing to main/develop."
        exit 1

    - name: âŒ Fail if build failed  
      if: needs.build.result != 'success'
      run: |
        echo "âŒ Build failed! Cannot proceed with push/merge."
        echo "ğŸ”§ Fix the build issues before pushing to main/develop."
        exit 1

    - name: âœ… All checks passed
      if: needs.test.result == 'success' && needs.build.result == 'success'
      run: |
        echo "âœ… All tests and builds passed successfully!"
        echo "ğŸš€ Safe to merge/push to protected branches."
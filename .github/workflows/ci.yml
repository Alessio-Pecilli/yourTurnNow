name: 🧪 CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: 🔍 Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true

    - name: 📦 Get dependencies
      run: flutter pub get

    - name: 🔧 Verify Flutter installation
      run: flutter doctor -v

    - name: ⚡ Analyze code
      run: flutter analyze --fatal-infos

    - name: 🧪 Run unit tests
      run: flutter test --coverage --reporter=expanded

    - name: 📊 Upload coverage to Codecov (optional)
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # Job separato per il build (opzionale ma utile)
  build:
    name: 🏗️ Build Check
    runs-on: ubuntu-latest
    needs: test # Esegue solo se i test passano

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true

    - name: 📦 Get dependencies
      run: flutter pub get

    - name: 🌐 Build web
      run: flutter build web --web-renderer canvaskit

    - name: 📱 Build APK
      run: flutter build apk --debug

  # Protezione branch - questo step fallirà se i test precedenti falliscono
  protection:
    name: 🛡️ Branch Protection
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()

    steps:
    - name: ❌ Fail if tests failed
      if: needs.test.result != 'success'
      run: |
        echo "❌ Tests failed! Cannot proceed with push/merge."
        echo "🔧 Fix the failing tests before pushing to main/develop."
        exit 1

    - name: ❌ Fail if build failed  
      if: needs.build.result != 'success'
      run: |
        echo "❌ Build failed! Cannot proceed with push/merge."
        echo "🔧 Fix the build issues before pushing to main/develop."
        exit 1

    - name: ✅ All checks passed
      if: needs.test.result == 'success' && needs.build.result == 'success'
      run: |
        echo "✅ All tests and builds passed successfully!"
        echo "🚀 Safe to merge/push to protected branches."